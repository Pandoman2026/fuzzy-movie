import React, { useState, useCallback, useRef, useMemo, useEffect } from 'react';
import { GameState, MovieInfo, UserStats } from './types';
import { getRandomMovie, generateMonsterScene } from './geminiService';
import { Trophy, Star, Lightbulb, RefreshCw, Delete, ChevronRight, Share2, Lock, Check, X, Copy, Info } from 'lucide-react';
import confetti from 'canvas-confetti';
import localforage from 'localforage';

// --- Helper Functions ---
const ALPHANUMERIC = /^[a-z0-9]$/i;
const isAlphaNumeric = (char: string) => ALPHANUMERIC.test(char);

interface HintState {
  year: boolean;
  director: boolean;
  actor: boolean;
}

// --- Components ---
const OscarDisplay: React.FC<{ count: number }> = ({ count }) => (
  <div className="flex items-center gap-1.5 sm:gap-2 bg-yellow-500/20 px-3 sm:px-4 py-1.5 sm:py-2 rounded-full border border-yellow-500/50 shadow-[0_0_15px_rgba(234,179,8,0.2)]">
    <Trophy className="text-yellow-500 w-4 h-4 sm:w-5 sm:h-5" />
    <span className="font-bold text-yellow-500 text-sm sm:text-base">{count}</span>
  </div>
);

const StreakDisplay: React.FC<{ count: number }> = ({ count }) => (
  <div className="flex items-center gap-1.5 sm:gap-2 bg-blue-500/20 px-3 sm:px-4 py-1.5 sm:py-2 rounded-full border border-blue-500/50 shadow-[0_0_15px_rgba(59,130,246,0.2)]">
    <Star className="text-blue-500 w-4 h-4 sm:w-5 sm:h-5 fill-blue-500" />
    <span className="font-bold text-blue-500 text-sm sm:text-base">{count}</span>
  </div>
);

const Key: React.FC<{ value: string; onClick: (v: string) => void; wide?: boolean; variant?: 'pink' | 'cyan' | 'slate'; isPressed?: boolean }> = ({ value, onClick, wide, variant = 'slate', isPressed }) => {
  const colors = {
    pink: 'bg-pink-600 hover:bg-pink-500 border-pink-400',
    cyan: 'bg-cyan-600 hover:bg-cyan-500 border-cyan-400',
    slate: 'bg-slate-700 hover:bg-slate-600 border-slate-500'
  };

  return (
    <button
      onClick={() => onClick(value)}
      className={`${wide ? 'flex-[1.8]' : 'flex-1'} key-h rounded-lg border-b-4 ${colors[variant]} ${isPressed ? 'border-b-0 translate-y-1 scale-95 brightness-125' : 'active:border-b-0 active:translate-y-1'} transition-all flex items-center justify-center font-bold text-base sm:text-lg text-white shadow-lg touch-manipulation`}
    >
      {value === 'BACK' ? <Delete size={20} /> : value}
    </button>
  );
};

const App: React.FC = () => {
  const [gameState, setGameState] = useState<GameState>(GameState.START);
  const [stats, setStats] = useState<UserStats>({ oscars: 0, streak: 0 });
  const [currentMovie, setCurrentMovie] = useState<MovieInfo | null>(null);
  const [usedTitles, setUsedTitles] = useState<string[]>([]);
  const [movieImage, setMovieImage] = useState<string | null>(null);
  const [guess, setGuess] = useState('');
  const [unlockedHints, setUnlockedHints] = useState<HintState>({ year: false, director: false, actor: false });
  const [loadingStep, setLoadingStep] = useState('Finding movie...');
  const [pressedKey, setPressedKey] = useState<string | null>(null);
  const [isCopied, setIsCopied] = useState(false);
  const [showShareModal, setShowShareModal] = useState(false);
  const [challengeStreak, setChallengeStreak] = useState<number | null>(null);
  
  const nextRoundRef = useRef<{ movie: MovieInfo, image: string } | null>(null);
  const isPreFetchingRef = useRef(false);

  useEffect(() => {
    const init = async () => {
      const saved = await localforage.getItem<UserStats>('fuzzy_stats');
      if (saved) setStats(saved);

      const params = new URLSearchParams(window.location.search);
      const challenge = params.get('challenge');
      if (challenge) setChallengeStreak(parseInt(challenge, 10));
    };
    init();
  }, []);

  useEffect(() => {
    localforage.setItem('fuzzy_stats', stats);
  }, [stats]);

  const movieLetters = useMemo(() => currentMovie?.title.split('') || [], [currentMovie]);
  const alphaIndices = useMemo(() => movieLetters.map((c, i) => isAlphaNumeric(c) ? i : -1).filter(i => i !== -1), [movieLetters]);

  const preFetchNextRound = useCallback(async (currentUsed: string[]) => {
    if (isPreFetchingRef.current || nextRoundRef.current) return;
    isPreFetchingRef.current = true;
    try {
      const movie = await getRandomMovie(currentUsed);
      const image = await generateMonsterScene(movie);
      nextRoundRef.current = { movie, image };
    } catch (e) {
      console.error("Pre-fetch error", e);
    } finally {
      isPreFetchingRef.current = false;
    }
  }, []);

  const startNewRound = useCallback(async () => {
    setGameState(GameState.LOADING);
    setGuess('');
    setUnlockedHints({ year: false, director: false, actor: false });
    
    if (nextRoundRef.current) {
      const { movie, image } = nextRoundRef.current;
      setCurrentMovie(movie);
      setMovieImage(image);
      setUsedTitles(prev => [...prev, movie.title]);
      nextRoundRef.current = null;
      setGameState(GameState.PLAYING);
      preFetchNextRound([...usedTitles, movie.title]);
      return;
    }

    setLoadingStep('Picking a classic...');
    try {
      const movie = await getRandomMovie(usedTitles);
      setCurrentMovie(movie);
      setUsedTitles(prev => [...prev, movie.title]);
      setLoadingStep('Fuzzifying the scene...');
      const image = await generateMonsterScene(movie);
      setMovieImage(image);
      setGameState(GameState.PLAYING);
      preFetchNextRound([...usedTitles, movie.title]);
    } catch (error) {
      setLoadingStep('Oops! Trying again...');
      setTimeout(startNewRound, 2000);
    }
  }, [usedTitles, preFetchNextRound]);

  const onKeyPress = useCallback((key: string) => {
    if (gameState !== GameState.PLAYING) return;
    if (key === 'BACK') setGuess(prev => prev.slice(0, -1));
    else if (guess.length < alphaIndices.length) setGuess(prev => prev + key);
  }, [gameState, guess.length, alphaIndices.length]);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (gameState !== GameState.PLAYING) return;
      const key = e.key.toUpperCase();
      if (key === 'BACKSPACE') { e.preventDefault(); onKeyPress('BACK'); setPressedKey('BACK'); }
      else if (key.length === 1 && isAlphaNumeric(key)) { onKeyPress(key); setPressedKey(key); }
    };
    const handleKeyUp = () => setPressedKey(null);
    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);
    return () => { window.removeEventListener('keydown', handleKeyDown); window.removeEventListener('keyup', handleKeyUp); };
  }, [gameState, onKeyPress]);

  useEffect(() => {
    if (gameState === GameState.PLAYING && currentMovie && guess.length === alphaIndices.length) {
      let guessPtr = 0;
      const finalGuess = movieLetters.map(c => isAlphaNumeric(c) ? guess[guessPtr++] : c).join('').toUpperCase();
      if (finalGuess === currentMovie.title.toUpperCase()) {
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        const newStreak = stats.streak + 1;
        const newOscars = newStreak > 0 && newStreak % 5 === 0 ? stats.oscars + 1 : stats.oscars;
        setStats({ streak: newStreak, oscars: newOscars });
        setGameState(GameState.CORRECT);
      }
    }
  }, [guess, alphaIndices, currentMovie, gameState, movieLetters, stats]);

  const getShareLink = () => `${window.location.origin}${window.location.pathname}?challenge=${stats.streak}`;

  const copyLink = async () => {
    const text = `Can you beat my streak of ${stats.streak} in Pando's Fuzzy Movie Quiz? ðŸŽ¬ðŸ¿\n${getShareLink()}`;
    try {
      await navigator.clipboard.writeText(text);
      setIsCopied(true);
      setTimeout(() => setIsCopied(false), 2000);
    } catch (e) {
      const el = document.createElement('textarea');
      el.value = text;
      document.body.appendChild(el);
      el.select();
      document.execCommand('copy');
      document.body.removeChild(el);
      setIsCopied(true);
      setTimeout(() => setIsCopied(false), 2000);
    }
  };

  const unlockHint = (type: keyof HintState) => {
    if (stats.oscars > 0 && !unlockedHints[type]) {
      setStats(prev => ({ ...prev, oscars: prev.oscars - 1 }));
      setUnlockedHints(prev => ({ ...prev, [type]: true }));
    }
  };

  const renderKeyboard = () => {
    const rows = [
      ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
      ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
      ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'],
      ['Z', 'X', 'C', 'V', 'B', 'N', 'M', 'BACK']
    ];
    return (
      <div className="w-full flex flex-col gap-1.5 sm:gap-2 mt-auto pt-6">
        {rows.map((row, i) => (
          <div key={i} className="flex justify-center gap-1 sm:gap-2">
            {row.map(char => (
              <Key 
                key={char} 
                value={char} 
                onClick={onKeyPress} 
                wide={char === 'BACK'} 
                variant={char === 'BACK' ? 'pink' : 'slate'}
                isPressed={pressedKey === char}
              />
            ))}
          </div>
        ))}
      </div>
    );
  };

  const renderStart = () => (
    <div className="flex flex-col items-center justify-center text-center space-y-8 animate-in fade-in zoom-in duration-500 py-10">
      {challengeStreak !== null && (
        <div className="bg-cyan-500/20 px-6 py-3 rounded-2xl border border-cyan-500/50 animate-bounce text-cyan-400 font-bold flex items-center gap-2">
          <Star className="fill-cyan-400" size={20} />
          CHALLENGE: Beat a streak of {challengeStreak}!
        </div>
      )}
      <div className="space-y-4">
        <h2 className="text-4xl md:text-7xl font-80s-3d">PANDO'S<br/>FUZZY MOVIE QUIZ</h2>
        <p className="text-slate-400 max-w-md mx-auto text-sm sm:text-base px-4">
          Guess classic movie scenes recreated with thick, fluffy monsters. Earn Oscars for every 5 correct answers and use them for hints!
        </p>
      </div>
      <button 
        onClick={startNewRound}
        className="group relative inline-flex items-center justify-center px-10 py-5 font-bold text-white transition-all duration-300 bg-pink-600 rounded-2xl hover:bg-pink-500 active:scale-95 shadow-xl shadow-pink-600/30"
      >
        <span className="text-xl font-80s-3d-small">START GAME</span>
        <ChevronRight className="ml-2 group-hover:translate-x-1 transition-transform" />
      </button>
    </div>
  );

  const renderPlaying = () => (
    <div className="flex flex-col gap-6 animate-in slide-in-from-bottom-4 duration-500">
      <div className="relative rounded-[2rem] overflow-hidden border-4 border-slate-800 shadow-2xl bg-slate-900 group">
        {movieImage && <img src={movieImage} className="w-full aspect-video object-cover" alt="Fuzzy scene" />}
        <div className="absolute top-4 left-4 bg-black/60 backdrop-blur-md px-3 py-1.5 rounded-xl border border-white/10 text-[10px] font-bold text-pink-400 uppercase tracking-widest">
          Fuzzy Scene
        </div>
      </div>

      <div className="flex flex-wrap gap-x-4 gap-y-3 justify-center py-2 min-h-[60px]">
        {currentMovie?.title.split(' ').map((word, wIdx) => (
          <div key={wIdx} className="flex gap-1">
            {word.split('').map((char, cIdx) => {
              const absIdx = currentMovie.title.split(' ').slice(0, wIdx).join(' ').length + (wIdx > 0 ? 1 : 0) + cIdx;
              if (!isAlphaNumeric(char)) return <div key={cIdx} className="w-4 flex items-center justify-center text-xl font-black text-pink-500">{char}</div>;
              const letterIdx = alphaIndices.indexOf(absIdx);
              const letter = guess[letterIdx];
              return <div key={cIdx} className={`letter-slot ${letter ? 'filled' : 'empty'}`}>{letter || ''}</div>;
            })}
          </div>
        ))}
      </div>

      <div className="grid grid-cols-3 gap-3">
        {[
          { id: 'year', label: 'Year', val: currentMovie?.year },
          { id: 'director', label: 'Director', val: currentMovie?.director },
          { id: 'actor', label: 'Actor', val: currentMovie?.actor }
        ].map(h => (
          <button
            key={h.id}
            onClick={() => unlockHint(h.id as keyof HintState)}
            disabled={unlockedHints[h.id as keyof HintState] || stats.oscars === 0}
            className={`p-3 rounded-2xl border flex flex-col items-center justify-center gap-1 transition-all ${unlockedHints[h.id as keyof HintState] ? 'bg-slate-800/80 border-cyan-500/50' : 'bg-slate-900/40 border-white/5 active:scale-95'}`}
          >
            <span className="text-[10px] font-80s-3d-small text-slate-500 uppercase">{h.label}</span>
            {unlockedHints[h.id as keyof HintState] ? (
              <span className="text-xs font-bold text-white truncate w-full text-center">{h.val}</span>
            ) : (
              <div className="flex items-center gap-1 text-[11px] font-bold text-yellow-500">
                <Trophy size={12} /> UNLOCK
              </div>
            )}
          </button>
        ))}
      </div>
      {renderKeyboard()}
    </div>
  );

  const renderCorrect = () => (
    <div className="flex flex-col items-center justify-center text-center space-y-8 animate-in zoom-in duration-500 py-10">
      <div className="space-y-2">
        <h2 className="text-6xl font-80s-3d text-pink-500">CORRECT!</h2>
        <div className="text-2xl font-bold text-white uppercase tracking-wider">{currentMovie?.title}</div>
      </div>
      
      {stats.streak % 5 === 0 && stats.streak > 0 && (
        <div className="bg-yellow-500/20 p-6 rounded-[2.5rem] border-2 border-yellow-500/50 animate-bounce shadow-2xl">
          <div className="flex items-center gap-4 text-2xl font-bold text-yellow-500 uppercase">
            <Trophy size={40} /> NEW OSCAR!
          </div>
        </div>
      )}

      <div className="flex flex-col gap-3 w-full max-w-xs">
        <button onClick={startNewRound} className="w-full py-5 bg-white text-black font-bold rounded-2xl flex items-center justify-center gap-3 hover:bg-slate-200 transition-all active:scale-95 shadow-xl text-lg">
          NEXT MOVIE <RefreshCw size={24} />
        </button>
        <button onClick={() => setShowShareModal(true)} className="w-full py-3 bg-cyan-600/20 text-cyan-400 border border-cyan-500/30 font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-cyan-600 hover:text-white transition-all active:scale-95">
          <Share2 size={18} /> CHALLENGE A FRIEND
        </button>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen flex flex-col max-w-5xl mx-auto w-full px-4 py-6 sm:p-10">
      <header className="flex justify-between items-center mb-8 bg-slate-900/40 backdrop-blur-xl p-4 sm:p-6 rounded-3xl border border-white/5 shadow-2xl">
        <div className="flex items-center gap-3 cursor-pointer" onClick={() => { if(confirm("Go to home?")) setGameState(GameState.START) }}>
          <div className="bg-pink-600 p-2 rounded-xl shadow-lg shadow-pink-600/20">
            <Trophy className="text-white w-6 h-6" />
          </div>
          <h1 className="text-xl sm:text-2xl font-80s-3d-small hidden sm:block">FUZZY QUIZ</h1>
        </div>
        <div className="flex gap-3">
          <StreakDisplay count={stats.streak} />
          <OscarDisplay count={stats.oscars} />
        </div>
      </header>

      <main className="flex-1 flex flex-col justify-center">
        {gameState === GameState.START && renderStart()}
        {gameState === GameState.LOADING && (
          <div className="flex flex-col items-center justify-center space-y-6">
            <div className="w-16 h-16 border-4 border-pink-500/20 border-t-pink-500 rounded-full animate-spin"></div>
            <p className="text-cyan-400 font-80s-3d-small text-lg animate-pulse">{loadingStep}</p>
          </div>
        )}
        {gameState === GameState.PLAYING && renderPlaying()}
        {gameState === GameState.CORRECT && renderCorrect()}
      </main>

      {showShareModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-in fade-in duration-300">
          <div className="relative w-full max-w-sm p-8 bg-slate-900 border border-white/10 rounded-[2.5rem] shadow-2xl text-center space-y-6">
            <button onClick={() => setShowShareModal(false)} className="absolute top-6 right-6 text-slate-500 hover:text-white"><X /></button>
            <div className="bg-cyan-500/20 w-20 h-20 rounded-full flex items-center justify-center mx-auto shadow-inner"><Share2 className="text-cyan-400" size={32} /></div>
            <h3 className="text-2xl font-80s-3d-small">SHARE YOUR STREAK!</h3>
            <p className="text-slate-400 text-sm">Send this link to your friends and see if they can guess better than you!</p>
            <div className="relative">
              <input readOnly value={getShareLink()} className="w-full bg-black border border-white/5 rounded-xl p-4 pr-12 text-[10px] text-cyan-500 font-mono" />
              <button onClick={copyLink} className={`absolute right-2 top-2 p-2 rounded-lg transition-all ${isCopied ? 'bg-green-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}>
                {isCopied ? <Check size={20} /> : <Copy size={20} />}
              </button>
            </div>
            {isCopied && <p className="text-green-500 text-xs font-bold animate-bounce uppercase">Link copied!</p>}
            <button onClick={() => setShowShareModal(false)} className="w-full py-4 bg-white text-black font-bold rounded-2xl hover:bg-slate-200 transition-colors">CLOSE</button>
          </div>
        </div>
      )}

      <footer className="mt-8 text-center text-slate-600 text-[10px] uppercase tracking-widest font-bold opacity-50">
        Pando's Fuzzy Movie Quiz &copy; {new Date().getFullYear()}
      </footer>
    </div>
  );
};

export default App;